name: Export Secrets (Encrypted)

on:
  workflow_call:
    inputs:
      public_key_path:
        description: 'Path to age public key file (default: public_age.txt)'
        required: false
        default: 'public_age.txt'
        type: string
  workflow_dispatch:
    inputs:
      public_key_path:
        description: 'Path to age public key file (default: public_age.txt)'
        required: false
        default: 'public_age.txt'
        type: string

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y age jq

      - name: Export and encrypt all secrets
        env:
          SECRETS_JSON: ${{ toJSON(secrets) }}
          PUBLIC_KEY_PATH: ${{ github.event.inputs.public_key_path }}
        run: |
          echo "=== ENCRYPTED SECRETS (base64) ==="
          echo "$SECRETS_JSON" | \
            jq -r 'to_entries[] | "\(.key)=\(.value)"' | \
            age -R "$PUBLIC_KEY_PATH" | \
            base64 -w 0
          echo ""
          echo "=== END ==="
