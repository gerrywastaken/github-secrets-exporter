name: Export Secrets (Encrypted)

on:
  workflow_dispatch:
    inputs:
      public_key_path:
        description: 'Path to age public key file (default: .github/data/public_age.txt)'
        required: false
        default: '.github/data/public_age.txt'
        type: string

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y age jq

      - name: Export and encrypt all secrets
        env:
          SECRETS_JSON: ${{ toJSON(secrets) }}
          PUBLIC_KEY_PATH: ${{ github.event.inputs.public_key_path }}
        run: |
          # Parse JSON with jq and create secrets file
          echo "$SECRETS_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' > secrets.env

          # Encrypt with age public key
          age -R "$PUBLIC_KEY_PATH" -o secrets.env.age secrets.env

          # Delete plaintext secrets immediately
          rm -f secrets.env

          # Output base64 (encrypted, safe to display)
          echo "=== ENCRYPTED SECRETS (base64) ==="
          base64 -w 0 secrets.env.age
          echo ""
          echo "=== END ==="

          # Clean up encrypted file
          rm -f secrets.env.age
